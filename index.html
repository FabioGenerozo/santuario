<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>PATRIMÔNIO DO SANTUÁRIO BOM JESUS DE PIRAPORINHA</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>PATRIMÔNIO DO SANTUÁRIO BOM JESUS DE PIRAPORINHA</h1>

<form id="formSolicitacao">
  <label>Nome: <input type="text" id="nome" required /></label><br/>
  <label>Departamento: <input type="text" id="departamento" required /></label><br/>
  <label>Itens:<br/>
    <textarea id="itens" placeholder="Formato: item,quantidade (uma linha por item)" required></textarea>
  </label><br/>
  <button type="submit">Enviar Solicitação</button>
</form>

<script>
  // Config Firebase (coloque sua config)
  const firebaseConfig = {
    databaseURL: "https://patrimonio-santuario-bjp-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const form = document.getElementById('formSolicitacao');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const nome = document.getElementById('nome').value.trim();
    const departamento = document.getElementById('departamento').value.trim();
    const itensRaw = document.getElementById('itens').value.trim();

    if (!nome || !departamento || !itensRaw) {
      alert("Preencha todos os campos!");
      return;
    }

    // Parse itens
    const itens = itensRaw.split('\n').map(line => {
      const [item, qtd] = line.split(',');
      return { item: item.trim(), quantidade: Number(qtd.trim()) };
    });

    // Buscar próximo número sequencial
    const numero = await getProximoNumeroSequencial();

    const dataAgora = new Date().toLocaleDateString();

    const solicitacao = {
      numero,
      nome,
      departamento,
      itens,
      dataSolicitacao: dataAgora
    };

    // Salvar no Firebase
    await db.ref('solicitacoes').push(solicitacao);

    // Gerar PDF
    gerarPdf(solicitacao);

    alert("Solicitação enviada com sucesso!");

    form.reset();
  });

  async function getProximoNumeroSequencial() {
    const snapshot = await db.ref('solicitacoes').once('value');
    const dados = snapshot.val() || {};
    // Pega o maior número existente
    const numeros = Object.values(dados).map(s => Number(s.numero));
    const maxNum = numeros.length ? Math.max(...numeros) : 0;
    return maxNum + 1;
  }

  function gerarPdf(solicitacao) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const margemEsquerda = 15;
    let y = 20;

    doc.setFontSize(16);
    doc.text("PATRIMÔNIO DO SANTUÁRIO BOM JESUS DE PIRAPORINHA", margemEsquerda, y);

    y += 15;
    doc.setFontSize(12);
    doc.text(`Número da Solicitação: ${solicitacao.numero}`, margemEsquerda, y);

    y += 10;
    doc.text(`Nome: ${solicitacao.nome}`, margemEsquerda, y);

    y += 10;
    doc.text(`Departamento: ${solicitacao.departamento}`, margemEsquerda, y);

    y += 10;
    doc.text(`Data da Solicitação: ${solicitacao.dataSolicitacao}`, margemEsquerda, y);

    y += 15;
    doc.setFontSize(14);
    doc.text("Itens da Solicitação:", margemEsquerda, y);

    y += 10;
    doc.setFontSize(12);
    solicitacao.itens.forEach(({ item, quantidade }) => {
      doc.text(`- ${item} (x${quantidade})`, margemEsquerda + 5, y);
      y += 8;
    });

    doc.save(`Solicitacao_${solicitacao.numero}.pdf`);
  }
</script>

</body>
</html>
