<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administração de Solicitações</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f1f1f1;
    }
    h1 {
      margin-bottom: 20px;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 0.95em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-devolver {
      background-color: #10b981;
      color: white;
    }
    .btn-voltar {
      background-color: #3b82f6;
      color: white;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <button class="btn-voltar" onclick="window.location.href='index.html'">← Voltar para Solicitações</button>
  <h1>Administração de Solicitações</h1>
  <ul id="listaAdmin"></ul>

  <script>
    const firebaseConfig = {
      databaseURL: "https://patrimonio-santuario-bjp-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const solicitacoesRef = database.ref("solicitacoes");
    const estoqueRef = database.ref("estoque");
    const listaAdmin = document.getElementById("listaAdmin");

    let estoqueAtual = {};

    estoqueRef.on("value", (snapshot) => {
      estoqueAtual = snapshot.val() || {};
    });

    function carregarSolicitacoes() {
      solicitacoesRef.once("value", (snapshot) => {
        const solicitacoes = snapshot.val() || {};
        listaAdmin.innerHTML = "";

        Object.entries(solicitacoes).forEach(([key, solic]) => {
          const li = document.createElement("li");
          const itensTexto = solic.itens.map(i => `${i.item} (${i.quantidade})`).join(", ");

          li.innerHTML = `
            <strong>${solic.solicitante}</strong> - ${solic.departamento}<br />
            Retirada: ${solic.dataRetirada} | Devolução: ${solic.dataDevolucao}<br />
            Itens: ${itensTexto}<br />
            <button class="btn-devolver" onclick="devolverItens('${key}', ${JSON.stringify(solic.itens).replace(/"/g, '&quot;')})">Registrar Devolução</button>
          `;

          listaAdmin.appendChild(li);
        });
      });
    }

    function devolverItens(chave, itens) {
      if (!confirm("Confirmar devolução e reposição dos itens ao estoque?")) return;

      const updates = {};
      itens.forEach(({ item, quantidade }) => {
        const atual = estoqueAtual[item] || 0;
        updates[`estoque/${item}`] = atual + quantidade;
      });

      updates[`solicitacoes/${chave}`] = null;

      database.ref().update(updates)
        .then(() => {
          alert("Itens devolvidos e estoque atualizado.");
          carregarSolicitacoes();
        })
        .catch((error) => {
          alert("Erro ao devolver itens: " + error.message);
        });
    }

    carregarSolicitacoes();
  </script>
</body>
</html>
